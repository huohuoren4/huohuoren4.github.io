import{_ as s,o as n,c as a,Q as e}from"./chunks/framework.01af844e.js";const h=JSON.parse('{"title":"Blueprints and Views","description":"","frontmatter":{},"headers":[],"relativePath":"python/flask/user_guide/tutorial/blueprint_view.md","filePath":"python/flask/user_guide/tutorial/blueprint_view.md","lastUpdated":1693328004000}'),l={name:"python/flask/user_guide/tutorial/blueprint_view.md"},o=e(`<h1 id="blueprints-and-views" tabindex="-1">Blueprints and Views <a class="header-anchor" href="#blueprints-and-views" aria-label="Permalink to &quot;Blueprints and Views {#blueprints-and-views}&quot;">​</a></h1><p>A view function is the code you write to respond to requests to your application. Flask uses patterns to match the incoming request URL to the view that should handle it. The view returns data that Flask turns into an outgoing response. Flask can also go the other direction and generate a URL to a view based on its name and arguments.</p><h2 id="create-a-blueprint" tabindex="-1">Create a Blueprint <a class="header-anchor" href="#create-a-blueprint" aria-label="Permalink to &quot;Create a Blueprint {#create-a-blueprint}&quot;">​</a></h2><p>A <code>Blueprint</code> is a way to organize a group of related views and other code. Rather than registering views and other code directly with an application, they are registered with a blueprint. Then the blueprint is registered with the application when it is available in the factory function.</p><p>Flaskr will have two blueprints, one for authentication functions and one for the blog posts functions. The code for each blueprint will go in a separate module. Since the blog needs to know about authentication, you’ll write the authentication one first.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> functools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flask </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    Blueprint, flash, g, redirect, render_template, request, session, url_for</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.security </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> check_password_hash, generate_password_hash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flaskr.db </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> get_db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">bp </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Blueprint(</span><span style="color:#9ECBFF;">&#39;auth&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">__name__</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">url_prefix</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;/auth&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> functools</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flask </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    Blueprint, flash, g, redirect, render_template, request, session, url_for</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.security </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> check_password_hash, generate_password_hash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flaskr.db </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> get_db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">bp </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Blueprint(</span><span style="color:#032F62;">&#39;auth&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;">, </span><span style="color:#E36209;">url_prefix</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;/auth&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>This creates a <code>Blueprint</code> named <code>&#39;auth&#39;</code>. Like the application object, the blueprint needs to know where it’s defined, so <code>__name__</code> is passed as the second argument. The <code>url_prefix</code> will be prepended to all the URLs associated with the blueprint.</p><p>Import and register the blueprint from the factory using <code>app.register_blueprint()</code>. Place the new code at the end of the factory function before returning the app.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/__init__.py</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">create_app</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># existing code omitted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> . </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> auth</span></span>
<span class="line"><span style="color:#E1E4E8;">    app.register_blueprint(auth.bp)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> app</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/__init__.py</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">create_app</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># existing code omitted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> . </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> auth</span></span>
<span class="line"><span style="color:#24292E;">    app.register_blueprint(auth.bp)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> app</span></span></code></pre></div><p>The authentication blueprint will have views to register new users and to log in and log out.</p><h2 id="the-first-view-register" tabindex="-1">The First View: Register <a class="header-anchor" href="#the-first-view-register" aria-label="Permalink to &quot;The First View: Register {#the-first-view-register}&quot;">​</a></h2><p>When the user visits the <code>/auth/register</code> URL, the <code>register</code> view will return <a href="https://developer.mozilla.org/docs/Web/HTML" target="_blank" rel="noreferrer">HTML</a> with a form for them to fill out. When they submit the form, it will validate their input and either show the form again with an error message or create the new user and go to the login page.</p><p>For now you will just write the view code. On the next page, you’ll write templates to generate the HTML form.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#B392F0;">@bp.route</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/register&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">methods</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;GET&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;POST&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">register</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> request.method </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;POST&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        username </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.form[</span><span style="color:#9ECBFF;">&#39;username&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        password </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.form[</span><span style="color:#9ECBFF;">&#39;password&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> get_db()</span></span>
<span class="line"><span style="color:#E1E4E8;">        error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> username:</span></span>
<span class="line"><span style="color:#E1E4E8;">            error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Username is required.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">elif</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> password:</span></span>
<span class="line"><span style="color:#E1E4E8;">            error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Password is required.&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> error </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                db.execute(</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#9ECBFF;">&quot;INSERT INTO user (username, password) VALUES (?, ?)&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                    (username, generate_password_hash(password)),</span></span>
<span class="line"><span style="color:#E1E4E8;">                )</span></span>
<span class="line"><span style="color:#E1E4E8;">                db.commit()</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">except</span><span style="color:#E1E4E8;"> db.IntegrityError:</span></span>
<span class="line"><span style="color:#E1E4E8;">                error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;User </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">username</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;"> is already registered.&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> redirect(url_for(</span><span style="color:#9ECBFF;">&quot;auth.login&quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        flash(error)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> render_template(</span><span style="color:#9ECBFF;">&#39;auth/register.html&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#6F42C1;">@bp.route</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/register&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">methods</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;GET&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;POST&#39;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">register</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> request.method </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;POST&#39;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        username </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> request.form[</span><span style="color:#032F62;">&#39;username&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        password </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> request.form[</span><span style="color:#032F62;">&#39;password&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> get_db()</span></span>
<span class="line"><span style="color:#24292E;">        error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> username:</span></span>
<span class="line"><span style="color:#24292E;">            error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Username is required.&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">elif</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> password:</span></span>
<span class="line"><span style="color:#24292E;">            error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Password is required.&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> error </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                db.execute(</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#032F62;">&quot;INSERT INTO user (username, password) VALUES (?, ?)&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                    (username, generate_password_hash(password)),</span></span>
<span class="line"><span style="color:#24292E;">                )</span></span>
<span class="line"><span style="color:#24292E;">                db.commit()</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">except</span><span style="color:#24292E;"> db.IntegrityError:</span></span>
<span class="line"><span style="color:#24292E;">                error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;User </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">username</span><span style="color:#005CC5;">}</span><span style="color:#032F62;"> is already registered.&quot;</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> redirect(url_for(</span><span style="color:#032F62;">&quot;auth.login&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        flash(error)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> render_template(</span><span style="color:#032F62;">&#39;auth/register.html&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Here’s what the <code>register</code> view function is doing:</p><ol><li><p><code>@bp.route</code> associates the URL <code>/register</code> with the <code>register</code> view function. When Flask receives a request to <code>/auth/register</code>, it will call the <code>register</code> view and use the return value as the response.</p></li><li><p>If the user submitted the form, <code>request.method</code> will be <code>&#39;POST&#39;</code>. In this case, start validating the input.</p></li><li><p><code>request.form</code> is a special type of <code>dict</code> mapping submitted form keys and values. The user will input their <code>username</code> and <code>password</code>.</p></li><li><p>Validate that <code>username</code> and <code>password</code> are not empty.</p></li><li><p>If validation succeeds, insert the new user data into the database.</p><ul><li><p><code>db.execute</code> takes a SQL query with <code>?</code> placeholders for any user input, and a tuple of values to replace the placeholders with. The database library will take care of escaping the values so you are not vulnerable to a <code>SQL injection attack</code>.</p></li><li><p>For security, passwords should never be stored in the database directly. Instead, <code>generate_password_hash()</code> is used to securely hash the password, and that hash is stored. Since this query modifies data, <code>db.commit()</code> needs to be called afterwards to save the changes.</p></li><li><p>An <code>sqlite3.IntegrityError</code> will occur if the username already exists, which should be shown to the user as another validation error.</p></li></ul></li><li><p>After storing the user, they are redirected to the login page. <code>url_for()</code> generates the URL for the login view based on its name. This is preferable to writing the URL directly as it allows you to change the URL later without changing all code that links to it. <code>redirect()</code> generates a redirect response to the generated URL.</p></li><li><p>If validation fails, the error is shown to the user. <code>flash()</code> stores messages that can be retrieved when rendering the template.</p></li><li><p>When the user initially navigates to <code>auth/register</code>, or there was a validation error, an HTML page with the registration form should be shown. <code>render_template()</code> will render a template containing the HTML, which you’ll write in the next step of the tutorial.</p></li></ol><h2 id="login" tabindex="-1">Login <a class="header-anchor" href="#login" aria-label="Permalink to &quot;Login {#login}&quot;">​</a></h2><p>This view follows the same pattern as the <code>register</code> view above.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#B392F0;">@bp.route</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/login&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">methods</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;GET&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;POST&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">login</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> request.method </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;POST&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        username </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.form[</span><span style="color:#9ECBFF;">&#39;username&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        password </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.form[</span><span style="color:#9ECBFF;">&#39;password&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> get_db()</span></span>
<span class="line"><span style="color:#E1E4E8;">        error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span></span>
<span class="line"><span style="color:#E1E4E8;">        user </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> db.execute(</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&#39;SELECT * FROM user WHERE username = ?&#39;</span><span style="color:#E1E4E8;">, (username,)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ).fetchone()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> user </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Incorrect username.&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">elif</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> check_password_hash(user[</span><span style="color:#9ECBFF;">&#39;password&#39;</span><span style="color:#E1E4E8;">], password):</span></span>
<span class="line"><span style="color:#E1E4E8;">            error </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Incorrect password.&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> error </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            session.clear()</span></span>
<span class="line"><span style="color:#E1E4E8;">            session[</span><span style="color:#9ECBFF;">&#39;user_id&#39;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> user[</span><span style="color:#9ECBFF;">&#39;id&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> redirect(url_for(</span><span style="color:#9ECBFF;">&#39;index&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        flash(error)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> render_template(</span><span style="color:#9ECBFF;">&#39;auth/login.html&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#6F42C1;">@bp.route</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/login&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">methods</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;GET&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;POST&#39;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">login</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> request.method </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;POST&#39;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        username </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> request.form[</span><span style="color:#032F62;">&#39;username&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        password </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> request.form[</span><span style="color:#032F62;">&#39;password&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> get_db()</span></span>
<span class="line"><span style="color:#24292E;">        error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span></span>
<span class="line"><span style="color:#24292E;">        user </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> db.execute(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&#39;SELECT * FROM user WHERE username = ?&#39;</span><span style="color:#24292E;">, (username,)</span></span>
<span class="line"><span style="color:#24292E;">        ).fetchone()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> user </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Incorrect username.&#39;</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">elif</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> check_password_hash(user[</span><span style="color:#032F62;">&#39;password&#39;</span><span style="color:#24292E;">], password):</span></span>
<span class="line"><span style="color:#24292E;">            error </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Incorrect password.&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> error </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            session.clear()</span></span>
<span class="line"><span style="color:#24292E;">            session[</span><span style="color:#032F62;">&#39;user_id&#39;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> user[</span><span style="color:#032F62;">&#39;id&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> redirect(url_for(</span><span style="color:#032F62;">&#39;index&#39;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        flash(error)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> render_template(</span><span style="color:#032F62;">&#39;auth/login.html&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>There are a few differences from the <code>register</code> view:</p><ol><li><p>The user is queried first and stored in a variable for later use. <code>fetchone()</code> returns one row from the query. If the query returned no results, it returns <code>None</code>. Later, <code>fetchall()</code> will be used, which returns a list of all results.</p></li><li><p><code>check_password_hash()</code> hashes the submitted password in the same way as the stored hash and securely compares them. If they match, the password is valid.</p></li><li><p><code>session</code> is a <code>dict</code> that stores data across requests. When validation succeeds, the user’s id is stored in a new session. The data is stored in a cookie that is sent to the browser, and the browser then sends it back with subsequent requests. Flask securely signs the data so that it can’t be tampered with.</p></li></ol><p>Now that the user’s <code>id</code> is stored in the <code>session</code>, it will be available on subsequent requests. At the beginning of each request, if a user is logged in their information should be loaded and made available to other views.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#B392F0;">@bp.before_app_request</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">load_logged_in_user</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    user_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> session.get(</span><span style="color:#9ECBFF;">&#39;user_id&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> user_id </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        g.user </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        g.user </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> get_db().execute(</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#9ECBFF;">&#39;SELECT * FROM user WHERE id = ?&#39;</span><span style="color:#E1E4E8;">, (user_id,)</span></span>
<span class="line"><span style="color:#E1E4E8;">        ).fetchone()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#6F42C1;">@bp.before_app_request</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">load_logged_in_user</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    user_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> session.get(</span><span style="color:#032F62;">&#39;user_id&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> user_id </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        g.user </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        g.user </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> get_db().execute(</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#032F62;">&#39;SELECT * FROM user WHERE id = ?&#39;</span><span style="color:#24292E;">, (user_id,)</span></span>
<span class="line"><span style="color:#24292E;">        ).fetchone()</span></span></code></pre></div><p><code>bp.before_app_request()</code> registers a function that runs before the view function, no matter what URL is requested. <code>load_logged_in_user</code> checks if a user id is stored in the <code>session</code> and gets that user’s data from the database, storing it on <code>g.user</code>, which lasts for the length of the request. If there is no user id, or if the id doesn’t exist, <code>g.user</code> will be <code>None</code>.</p><h2 id="logout" tabindex="-1">Logout <a class="header-anchor" href="#logout" aria-label="Permalink to &quot;Logout {#logout}&quot;">​</a></h2><p>To log out, you need to remove the user id from the <code>session</code>. Then <code>load_logged_in_user</code> won’t load a user on subsequent requests.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#B392F0;">@bp.route</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/logout&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">logout</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    session.clear()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> redirect(url_for(</span><span style="color:#9ECBFF;">&#39;index&#39;</span><span style="color:#E1E4E8;">))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#6F42C1;">@bp.route</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/logout&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">logout</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    session.clear()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> redirect(url_for(</span><span style="color:#032F62;">&#39;index&#39;</span><span style="color:#24292E;">))</span></span></code></pre></div><h2 id="require-authentication-in-other-views" tabindex="-1">Require Authentication in Other Views <a class="header-anchor" href="#require-authentication-in-other-views" aria-label="Permalink to &quot;Require Authentication in Other Views {#require-authentication-in-other-views}&quot;">​</a></h2><p>Creating, editing, and deleting blog posts will require a user to be logged in. A decorator can be used to check this for each view it’s applied to.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">login_required</span><span style="color:#E1E4E8;">(view):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">@functools.wraps</span><span style="color:#E1E4E8;">(view)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">wrapped_view</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">kwargs):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> g.user </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> redirect(url_for(</span><span style="color:#9ECBFF;">&#39;auth.login&#39;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> view(</span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">kwargs)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> wrapped_view</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># flaskr/auth.py</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">login_required</span><span style="color:#24292E;">(view):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">@functools.wraps</span><span style="color:#24292E;">(view)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">wrapped_view</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> g.user </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> redirect(url_for(</span><span style="color:#032F62;">&#39;auth.login&#39;</span><span style="color:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> view(</span><span style="color:#D73A49;">**</span><span style="color:#24292E;">kwargs)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> wrapped_view</span></span></code></pre></div><p>This decorator returns a new view function that wraps the original view it’s applied to. The new function checks if a user is loaded and redirects to the login page otherwise. If a user is loaded the original view is called and continues normally. You’ll use this decorator when writing the blog views.</p><h2 id="endpoints-and-urls" tabindex="-1">Endpoints and URLs <a class="header-anchor" href="#endpoints-and-urls" aria-label="Permalink to &quot;Endpoints and URLs {#endpoints-and-urls}&quot;">​</a></h2><p>The <code>url_for()</code> function generates the URL to a view based on a name and arguments. The name associated with a view is also called the endpoint, and by default it’s the same as the name of the view function.</p><p>For example, the <code>hello()</code> view that was added to the app factory earlier in the tutorial has the name <code>&#39;hello&#39;</code> and can be linked to with <code>url_for(&#39;hello&#39;)</code>. If it took an argument, which you’ll see later, it would be linked to using <code>url_for(&#39;hello&#39;, who=&#39;World&#39;)</code>.</p><p>When using a blueprint, the name of the blueprint is prepended to the name of the function, so the endpoint for the <code>login</code> function you wrote above is <code>&#39;auth.login&#39;</code> because you added it to the <code>&#39;auth&#39;</code> blueprint.</p><p>Continue to <a href="/python/flask/user_guide/tutorial/template#templates">Templates</a>.</p>`,36),p=[o];function t(r,c,i,E,y,d){return n(),a("div",null,p)}const F=s(l,[["render",t]]);export{h as __pageData,F as default};
