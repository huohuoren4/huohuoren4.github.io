import{_ as e,o,c as a,Q as n}from"./chunks/framework.01af844e.js";const f=JSON.parse('{"title":"Container Lifecycle Hooks","description":"","frontmatter":{},"headers":[],"relativePath":"container/k8s/concept/container/container_life_hook.md","filePath":"container/k8s/concept/container/container_life_hook.md","lastUpdated":1694607182000}'),t={name:"container/k8s/concept/container/container_life_hook.md"},s=n(`<h1 id="container-lifecycle-hooks" tabindex="-1">Container Lifecycle Hooks <a class="header-anchor" href="#container-lifecycle-hooks" aria-label="Permalink to &quot;Container Lifecycle Hooks&quot;">​</a></h1><p>This page describes how kubelet managed Containers can use the Container lifecycle hook framework to run code triggered by events during their management lifecycle.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Analogous to many programming language frameworks that have component lifecycle hooks, such as Angular, Kubernetes provides Containers with lifecycle hooks. The hooks enable Containers to be aware of events in their management lifecycle and run code implemented in a handler when the corresponding lifecycle hook is executed.</p><h2 id="container-hooks" tabindex="-1">Container hooks <a class="header-anchor" href="#container-hooks" aria-label="Permalink to &quot;Container hooks&quot;">​</a></h2><p>There are two hooks that are exposed to Containers:</p><p><code>PostStart</code></p><p>This hook is executed immediately after a container is created. However, there is no guarantee that the hook will execute before the container ENTRYPOINT. No parameters are passed to the handler.</p><p><code>PreStop</code></p><p>This hook is called immediately before a container is terminated due to an API request or management event such as a liveness/startup probe failure, preemption, resource contention and others. A call to the <code>PreStop</code> hook fails if the container is already in a terminated or completed state and the hook must complete before the TERM signal to stop the container can be sent. The Pod&#39;s termination grace period countdown begins before the <code>PreStop</code> hook is executed, so regardless of the outcome of the handler, the container will eventually terminate within the Pod&#39;s termination grace period. No parameters are passed to the handler.</p><p>A more detailed description of the termination behavior can be found in <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination" target="_blank" rel="noreferrer">Termination of Pods</a>.</p><h3 id="hook-handler-implementations" tabindex="-1">Hook handler implementations <a class="header-anchor" href="#hook-handler-implementations" aria-label="Permalink to &quot;Hook handler implementations&quot;">​</a></h3><p>Containers can access a hook by implementing and registering a handler for that hook. There are two types of hook handlers that can be implemented for Containers:</p><ul><li>Exec - Executes a specific command, such as <code>pre-stop.sh</code>, inside the cgroups and namespaces of the Container. Resources consumed by the command are counted against the Container.</li><li>HTTP - Executes an HTTP request against a specific endpoint on the Container.</li></ul><h3 id="hook-handler-execution" tabindex="-1">Hook handler execution <a class="header-anchor" href="#hook-handler-execution" aria-label="Permalink to &quot;Hook handler execution&quot;">​</a></h3><p>When a Container lifecycle management hook is called, the Kubernetes management system executes the handler according to the hook action, <code>httpGet</code> and <code>tcpSocket</code> are executed by the kubelet process, and <code>exec</code> is executed in the container.</p><p>Hook handler calls are synchronous within the context of the Pod containing the Container. This means that for a <code>PostStart</code> hook, the Container ENTRYPOINT and hook fire asynchronously. However, if the hook takes too long to run or hangs, the Container cannot reach a <code>running</code> state.</p><p><code>PreStop</code> hooks are not executed asynchronously from the signal to stop the Container; the hook must complete its execution before the TERM signal can be sent. If a <code>PreStop</code> hook hangs during execution, the Pod&#39;s phase will be <code>Terminating</code> and remain there until the Pod is killed after its <code>terminationGracePeriodSeconds</code> expires. This grace period applies to the total time it takes for both the <code>PreStop</code> hook to execute and for the Container to stop normally. If, for example, <code>terminationGracePeriodSeconds</code> is 60, and the hook takes 55 seconds to complete, and the Container takes 10 seconds to stop normally after receiving the signal, then the Container will be killed before it can stop normally, since <code>terminationGracePeriodSeconds</code> is less than the total time (55+10) it takes for these two things to happen.</p><p>If either a <code>PostStart</code> or <code>PreStop</code> hook fails, it kills the Container.</p><p>Users should make their hook handlers as lightweight as possible. There are cases, however, when long running commands make sense, such as when saving state prior to stopping a Container.</p><h3 id="hook-delivery-guarantees" tabindex="-1">Hook delivery guarantees <a class="header-anchor" href="#hook-delivery-guarantees" aria-label="Permalink to &quot;Hook delivery guarantees&quot;">​</a></h3><p>Hook delivery is intended to be at least once, which means that a hook may be called multiple times for any given event, such as for <code>PostStart</code> or <code>PreStop</code>. It is up to the hook implementation to handle this correctly.</p><p>Generally, only single deliveries are made. If, for example, an HTTP hook receiver is down and is unable to take traffic, there is no attempt to resend. In some rare cases, however, double delivery may occur. For instance, if a kubelet restarts in the middle of sending a hook, the hook might be resent after the kubelet comes back up.</p><h3 id="debugging-hook-handlers" tabindex="-1">Debugging Hook handlers <a class="header-anchor" href="#debugging-hook-handlers" aria-label="Permalink to &quot;Debugging Hook handlers&quot;">​</a></h3><p>The logs for a Hook handler are not exposed in Pod events. If a handler fails for some reason, it broadcasts an event. For <code>PostStart</code>, this is the <code>FailedPostStartHook</code> event, and for <code>PreStop</code>, this is the <code>FailedPreStopHook</code> event. To generate a failed <code>FailedPostStartHook</code> event yourself, modify the <a href="https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/lifecycle-events.yaml" target="_blank" rel="noreferrer">lifecycle-events.yaml</a> file to change the postStart command to &quot;badcommand&quot; and apply it. Here is some example output of the resulting events you see from running <code>kubectl describe pod lifecycle-demo</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Events:</span></span>
<span class="line"><span style="color:#e1e4e8;">  Type     Reason               Age              From               Message</span></span>
<span class="line"><span style="color:#e1e4e8;">  ----     ------               ----             ----               -------</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Scheduled            7s               default-scheduler  Successfully assigned default/lifecycle-demo to ip-XXX-XXX-XX-XX.us-east-2...</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Pulled               6s               kubelet            Successfully pulled image &quot;nginx&quot; in 229.604315ms</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Pulling              4s (x2 over 6s)  kubelet            Pulling image &quot;nginx&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Created              4s (x2 over 5s)  kubelet            Created container lifecycle-demo-container</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Started              4s (x2 over 5s)  kubelet            Started container lifecycle-demo-container</span></span>
<span class="line"><span style="color:#e1e4e8;">  Warning  FailedPostStartHook  4s (x2 over 5s)  kubelet            Exec lifecycle hook ([badcommand]) for Container &quot;lifecycle-demo-container&quot; in Pod &quot;lifecycle-demo_default(30229739-9651-4e5a-9a32-a8f1688862db)&quot; failed - error: command &#39;badcommand&#39; exited with 126: , message: &quot;OCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: \\&quot;badcommand\\&quot;: executable file not found in $PATH: unknown\\r\\n&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Killing              4s (x2 over 5s)  kubelet            FailedPostStartHook</span></span>
<span class="line"><span style="color:#e1e4e8;">  Normal   Pulled               4s               kubelet            Successfully pulled image &quot;nginx&quot; in 215.66395ms</span></span>
<span class="line"><span style="color:#e1e4e8;">  Warning  BackOff              2s (x2 over 3s)  kubelet            Back-off restarting failed container</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Events:</span></span>
<span class="line"><span style="color:#24292e;">  Type     Reason               Age              From               Message</span></span>
<span class="line"><span style="color:#24292e;">  ----     ------               ----             ----               -------</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Scheduled            7s               default-scheduler  Successfully assigned default/lifecycle-demo to ip-XXX-XXX-XX-XX.us-east-2...</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Pulled               6s               kubelet            Successfully pulled image &quot;nginx&quot; in 229.604315ms</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Pulling              4s (x2 over 6s)  kubelet            Pulling image &quot;nginx&quot;</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Created              4s (x2 over 5s)  kubelet            Created container lifecycle-demo-container</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Started              4s (x2 over 5s)  kubelet            Started container lifecycle-demo-container</span></span>
<span class="line"><span style="color:#24292e;">  Warning  FailedPostStartHook  4s (x2 over 5s)  kubelet            Exec lifecycle hook ([badcommand]) for Container &quot;lifecycle-demo-container&quot; in Pod &quot;lifecycle-demo_default(30229739-9651-4e5a-9a32-a8f1688862db)&quot; failed - error: command &#39;badcommand&#39; exited with 126: , message: &quot;OCI runtime exec failed: exec failed: container_linux.go:380: starting container process caused: exec: \\&quot;badcommand\\&quot;: executable file not found in $PATH: unknown\\r\\n&quot;</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Killing              4s (x2 over 5s)  kubelet            FailedPostStartHook</span></span>
<span class="line"><span style="color:#24292e;">  Normal   Pulled               4s               kubelet            Successfully pulled image &quot;nginx&quot; in 215.66395ms</span></span>
<span class="line"><span style="color:#24292e;">  Warning  BackOff              2s (x2 over 3s)  kubelet            Back-off restarting failed container</span></span></code></pre></div><h2 id="what-s-next" tabindex="-1">What&#39;s next <a class="header-anchor" href="#what-s-next" aria-label="Permalink to &quot;What&#39;s next&quot;">​</a></h2><ul><li>Learn more about the <a href="https://kubernetes.io/docs/concepts/containers/container-environment/" target="_blank" rel="noreferrer">Container environment</a>.</li><li>Get hands-on experience <a href="https://kubernetes.io/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/" target="_blank" rel="noreferrer">attaching handlers to Container lifecycle events</a>.</li></ul>`,28),r=[s];function i(l,c,d,h,p,u){return o(),a("div",null,r)}const k=e(t,[["render",i]]);export{f as __pageData,k as default};
