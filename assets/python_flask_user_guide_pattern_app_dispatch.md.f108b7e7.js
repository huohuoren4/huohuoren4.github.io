import{_ as s,o as a,c as n,Q as p}from"./chunks/framework.01af844e.js";const u=JSON.parse('{"title":"Application Dispatching","description":"","frontmatter":{},"headers":[],"relativePath":"python/flask/user_guide/pattern/app_dispatch.md","filePath":"python/flask/user_guide/pattern/app_dispatch.md","lastUpdated":1693404008000}'),l={name:"python/flask/user_guide/pattern/app_dispatch.md"},o=p(`<h1 id="application-dispatching" tabindex="-1">Application Dispatching <a class="header-anchor" href="#application-dispatching" aria-label="Permalink to &quot;Application Dispatching {#application-dispatching}&quot;">​</a></h1><p>Application dispatching is the process of combining multiple Flask applications on the WSGI level. You can combine not only Flask applications but any WSGI application. This would allow you to run a Django and a Flask application in the same interpreter side by side if you want. The usefulness of this depends on how the applications work internally.</p><p>The fundamental difference from <a href="/python/flask/user_guide/pattern/large_app#large-applications-as-packages">Large Applications as Packages</a> is that in this case you are running the same or different Flask applications that are entirely isolated from each other. They run different configurations and are dispatched on the WSGI level.</p><h2 id="working-with-this-document" tabindex="-1">Working with this Document <a class="header-anchor" href="#working-with-this-document" aria-label="Permalink to &quot;Working with this Document {#working-with-this-document}&quot;">​</a></h2><p>Each of the techniques and examples below results in an <code>application</code> object that can be run with any WSGI server. For production, see <a href="/python/flask/user_guide/deploy#deploying-to-production">Deploying to Production</a>. For development, Werkzeug provides a server through <code>werkzeug.serving.run_simple()</code>:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.serving </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> run_simple</span></span>
<span class="line"><span style="color:#E1E4E8;">run_simple(</span><span style="color:#9ECBFF;">&#39;localhost&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;">, application, </span><span style="color:#FFAB70;">use_reloader</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.serving </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> run_simple</span></span>
<span class="line"><span style="color:#24292E;">run_simple(</span><span style="color:#032F62;">&#39;localhost&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5000</span><span style="color:#24292E;">, application, </span><span style="color:#E36209;">use_reloader</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Note that <code>run_simple</code> is not intended for use in production. Use a production WSGI server. See <a href="/python/flask/user_guide/deploy#deploying-to-production">Deploying to Production</a>.</p><p>In order to use the interactive debugger, debugging must be enabled both on the application and the simple server. Here is the “hello world” example with debugging and <code>run_simple</code>:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flask </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> Flask</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.serving </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> run_simple</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Flask(</span><span style="color:#79B8FF;">__name__</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">app.debug </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">@app.route</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">hello_world</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;Hello World!&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__name__</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;__main__&#39;</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    run_simple(</span><span style="color:#9ECBFF;">&#39;localhost&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">5000</span><span style="color:#E1E4E8;">, app,</span></span>
<span class="line"><span style="color:#E1E4E8;">               </span><span style="color:#FFAB70;">use_reloader</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">use_debugger</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">use_evalex</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">True</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flask </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Flask</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.serving </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> run_simple</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Flask(</span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">app.debug </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">@app.route</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">hello_world</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;Hello World!&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;__main__&#39;</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    run_simple(</span><span style="color:#032F62;">&#39;localhost&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">5000</span><span style="color:#24292E;">, app,</span></span>
<span class="line"><span style="color:#24292E;">               </span><span style="color:#E36209;">use_reloader</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">, </span><span style="color:#E36209;">use_debugger</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">, </span><span style="color:#E36209;">use_evalex</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">True</span><span style="color:#24292E;">)</span></span></code></pre></div><h2 id="combining-applications" tabindex="-1">Combining Applications <a class="header-anchor" href="#combining-applications" aria-label="Permalink to &quot;Combining Applications {#combining-applications}&quot;">​</a></h2><p>If you have entirely separated applications and you want them to work next to each other in the same Python interpreter process you can take advantage of the <code>werkzeug.wsgi.DispatcherMiddleware</code>. The idea here is that each Flask application is a valid WSGI application and they are combined by the dispatcher middleware into a larger one that is dispatched based on prefix.</p><p>For example you could have your main application run on <code>/</code> and your backend interface on <code>/backend</code>:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.middleware.dispatcher </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> DispatcherMiddleware</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> frontend_app </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> application </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> frontend</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> backend_app </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> application </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> backend</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">application </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> DispatcherMiddleware(frontend, {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&#39;/backend&#39;</span><span style="color:#E1E4E8;">: backend</span></span>
<span class="line"><span style="color:#E1E4E8;">})</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.middleware.dispatcher </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> DispatcherMiddleware</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> frontend_app </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> application </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> frontend</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> backend_app </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> application </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> backend</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">application </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> DispatcherMiddleware(frontend, {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&#39;/backend&#39;</span><span style="color:#24292E;">: backend</span></span>
<span class="line"><span style="color:#24292E;">})</span></span></code></pre></div><h2 id="dispatch-by-subdomain" tabindex="-1">Dispatch by Subdomain <a class="header-anchor" href="#dispatch-by-subdomain" aria-label="Permalink to &quot;Dispatch by Subdomain {#dispatch-by-subdomain}&quot;">​</a></h2><p>Sometimes you might want to use multiple instances of the same application with different configurations. Assuming the application is created inside a function and you can call that function to instantiate it, that is really easy to implement. In order to develop your application to support creating new instances in functions have a look at the <a href="/python/flask/user_guide/pattern/app_factories#application-factories">Application Factories</a> pattern.</p><p>A very common example would be creating applications per subdomain. For instance you configure your webserver to dispatch all requests for all subdomains to your application and you then use the subdomain information to create user-specific instances. Once you have your server set up to listen on all subdomains you can use a very simple WSGI application to do the dynamic application creation.</p><p>The perfect level for abstraction in that regard is the WSGI layer. You write your own WSGI application that looks at the request that comes and delegates it to your Flask application. If that application does not exist yet, it is dynamically created and remembered:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> threading </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> Lock</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SubdomainDispatcher</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self, domain, create_app):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.domain </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> domain</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.create_app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> create_app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.lock </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Lock()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.instances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">get_application</span><span style="color:#E1E4E8;">(self, host):</span></span>
<span class="line"><span style="color:#E1E4E8;">        host </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> host.split(</span><span style="color:#9ECBFF;">&#39;:&#39;</span><span style="color:#E1E4E8;">)[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">assert</span><span style="color:#E1E4E8;"> host.endswith(</span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.domain), </span><span style="color:#9ECBFF;">&#39;Configuration error&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">        subdomain </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> host[:</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.domain)].rstrip(</span><span style="color:#9ECBFF;">&#39;.&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.lock:</span></span>
<span class="line"><span style="color:#E1E4E8;">            app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.instances.get(subdomain)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> app </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.create_app(subdomain)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.instances[subdomain] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> app</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__call__</span><span style="color:#E1E4E8;">(self, environ, start_response):</span></span>
<span class="line"><span style="color:#E1E4E8;">        app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.get_application(environ[</span><span style="color:#9ECBFF;">&#39;HTTP_HOST&#39;</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> app(environ, start_response)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> threading </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Lock</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SubdomainDispatcher</span><span style="color:#24292E;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self, domain, create_app):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.domain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> domain</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.create_app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> create_app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.lock </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Lock()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.instances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get_application</span><span style="color:#24292E;">(self, host):</span></span>
<span class="line"><span style="color:#24292E;">        host </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> host.split(</span><span style="color:#032F62;">&#39;:&#39;</span><span style="color:#24292E;">)[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">assert</span><span style="color:#24292E;"> host.endswith(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.domain), </span><span style="color:#032F62;">&#39;Configuration error&#39;</span></span>
<span class="line"><span style="color:#24292E;">        subdomain </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> host[:</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.domain)].rstrip(</span><span style="color:#032F62;">&#39;.&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.lock:</span></span>
<span class="line"><span style="color:#24292E;">            app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.instances.get(subdomain)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> app </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.create_app(subdomain)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.instances[subdomain] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> app</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__call__</span><span style="color:#24292E;">(self, environ, start_response):</span></span>
<span class="line"><span style="color:#24292E;">        app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.get_application(environ[</span><span style="color:#032F62;">&#39;HTTP_HOST&#39;</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> app(environ, start_response)</span></span></code></pre></div><p>This dispatcher can then be used like this:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> myapplication </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> create_app, get_user_for_subdomain</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.exceptions </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> NotFound</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">make_app</span><span style="color:#E1E4E8;">(subdomain):</span></span>
<span class="line"><span style="color:#E1E4E8;">    user </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> get_user_for_subdomain(subdomain)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> user </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># if there is no user for that subdomain we still have</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># to return a WSGI application that handles that request.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># We can then just return the NotFound() exception as</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># application which will render a default 404 page.</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#6A737D;"># You might also redirect the user to the main page then</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> NotFound()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># otherwise create the application for the specific user</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> create_app(user)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">application </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> SubdomainDispatcher(</span><span style="color:#9ECBFF;">&#39;example.com&#39;</span><span style="color:#E1E4E8;">, make_app)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> myapplication </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> create_app, get_user_for_subdomain</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.exceptions </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> NotFound</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">make_app</span><span style="color:#24292E;">(subdomain):</span></span>
<span class="line"><span style="color:#24292E;">    user </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> get_user_for_subdomain(subdomain)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> user </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># if there is no user for that subdomain we still have</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># to return a WSGI application that handles that request.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># We can then just return the NotFound() exception as</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># application which will render a default 404 page.</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#6A737D;"># You might also redirect the user to the main page then</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> NotFound()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># otherwise create the application for the specific user</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> create_app(user)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">application </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> SubdomainDispatcher(</span><span style="color:#032F62;">&#39;example.com&#39;</span><span style="color:#24292E;">, make_app)</span></span></code></pre></div><h2 id="dispatch-by-path" tabindex="-1">Dispatch by Path <a class="header-anchor" href="#dispatch-by-path" aria-label="Permalink to &quot;Dispatch by Path {#dispatch-by-path}&quot;">​</a></h2><p>Dispatching by a path on the URL is very similar. Instead of looking at the <code>Host</code> header to figure out the subdomain one simply looks at the request path up to the first slash:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> threading </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> Lock</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.wsgi </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> pop_path_info, peek_path_info</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PathDispatcher</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self, default_app, create_app):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.default_app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> default_app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.create_app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> create_app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.lock </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Lock()</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.instances </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">get_application</span><span style="color:#E1E4E8;">(self, prefix):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.lock:</span></span>
<span class="line"><span style="color:#E1E4E8;">            app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.instances.get(prefix)</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> app </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.create_app(prefix)</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> app </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">                    </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.instances[prefix] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> app</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__call__</span><span style="color:#E1E4E8;">(self, environ, start_response):</span></span>
<span class="line"><span style="color:#E1E4E8;">        app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.get_application(peek_path_info(environ))</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> app </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            pop_path_info(environ)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">.default_app</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> app(environ, start_response)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> threading </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Lock</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.wsgi </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> pop_path_info, peek_path_info</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PathDispatcher</span><span style="color:#24292E;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self, default_app, create_app):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.default_app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> default_app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.create_app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> create_app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.lock </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Lock()</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.instances </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get_application</span><span style="color:#24292E;">(self, prefix):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.lock:</span></span>
<span class="line"><span style="color:#24292E;">            app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.instances.get(prefix)</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> app </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.create_app(prefix)</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> app </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">                    </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.instances[prefix] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> app</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__call__</span><span style="color:#24292E;">(self, environ, start_response):</span></span>
<span class="line"><span style="color:#24292E;">        app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.get_application(peek_path_info(environ))</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> app </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            pop_path_info(environ)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">else</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">.default_app</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> app(environ, start_response)</span></span></code></pre></div><p>The big difference between this and the subdomain one is that this one falls back to another application if the creator function returns <code>None</code>:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> myapplication </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> create_app, default_app, get_user_for_prefix</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">make_app</span><span style="color:#E1E4E8;">(prefix):</span></span>
<span class="line"><span style="color:#E1E4E8;">    user </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> get_user_for_prefix(prefix)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> user </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> create_app(user)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">application </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> PathDispatcher(default_app, make_app)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> myapplication </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> create_app, default_app, get_user_for_prefix</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">make_app</span><span style="color:#24292E;">(prefix):</span></span>
<span class="line"><span style="color:#24292E;">    user </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> get_user_for_prefix(prefix)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> user </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> create_app(user)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">application </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> PathDispatcher(default_app, make_app)</span></span></code></pre></div>`,25),e=[o];function t(c,r,i,E,y,d){return a(),n("div",null,e)}const F=s(l,[["render",t]]);export{u as __pageData,F as default};
