import{_ as e,o as s,c as a,Q as n}from"./chunks/framework.01af844e.js";const u=JSON.parse('{"title":"DaemonSet","description":"","frontmatter":{},"headers":[],"relativePath":"container/k8s/concept/workload/workload/daemonset.md","filePath":"container/k8s/concept/workload/workload/daemonset.md","lastUpdated":1694607182000}'),o={name:"container/k8s/concept/workload/workload/daemonset.md"},t=n(`<h1 id="daemonset" tabindex="-1">DaemonSet <a class="header-anchor" href="#daemonset" aria-label="Permalink to &quot;DaemonSet&quot;">​</a></h1><p>A DaemonSet ensures that all (or some) Nodes run a copy of a Pod. As nodes are added to the cluster, Pods are added to them. As nodes are removed from the cluster, those Pods are garbage collected. Deleting a DaemonSet will clean up the Pods it created.</p><p>Some typical uses of a DaemonSet are:</p><ul><li>running a cluster storage daemon on every node</li><li>running a logs collection daemon on every node</li><li>running a node monitoring daemon on every node</li></ul><p>In a simple case, one DaemonSet, covering all nodes, would be used for each type of daemon. A more complex setup might use multiple DaemonSets for a single type of daemon, but with different flags and/or different memory and cpu requests for different hardware types.</p><h2 id="writing-a-daemonset-spec" tabindex="-1">Writing a DaemonSet Spec <a class="header-anchor" href="#writing-a-daemonset-spec" aria-label="Permalink to &quot;Writing a DaemonSet Spec&quot;">​</a></h2><h3 id="create-a-daemonset" tabindex="-1">Create a DaemonSet <a class="header-anchor" href="#create-a-daemonset" aria-label="Permalink to &quot;Create a DaemonSet&quot;">​</a></h3><p>You can describe a DaemonSet in a YAML file. For example, the <code>daemonset.yaml</code> file below describes a DaemonSet that runs the fluentd-elasticsearch Docker image:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#9ECBFF;">controllers/daemonset.yaml</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">DaemonSet</span></span>
<span class="line"><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">namespace</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kube-system</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">k8s-app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">fluentd-logging</span></span>
<span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">tolerations</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># these tolerations are to have the daemonset runnable on control plane nodes</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;"># remove them if your control plane nodes should not run pods</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-role.kubernetes.io/control-plane</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Exists</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NoSchedule</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">node-role.kubernetes.io/master</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Exists</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">effect</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">NoSchedule</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">containers</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">image</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">resources</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">limits</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">requests</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">cpu</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">100m</span></span>
<span class="line"><span style="color:#E1E4E8;">            </span><span style="color:#85E89D;">memory</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">200Mi</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">volumeMounts</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">varlog</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">mountPath</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/log</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">terminationGracePeriodSeconds</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#85E89D;">volumes</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">name</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">varlog</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">hostPath</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#85E89D;">path</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">/var/log</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#032F62;">controllers/daemonset.yaml</span></span>
<span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">apps/v1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">DaemonSet</span></span>
<span class="line"><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">namespace</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kube-system</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">k8s-app</span><span style="color:#24292E;">: </span><span style="color:#032F62;">fluentd-logging</span></span>
<span class="line"><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">selector</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">matchLabels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">template</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">metadata</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">labels</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">spec</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">tolerations</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># these tolerations are to have the daemonset runnable on control plane nodes</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;"># remove them if your control plane nodes should not run pods</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-role.kubernetes.io/control-plane</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Exists</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NoSchedule</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">node-role.kubernetes.io/master</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">Exists</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">effect</span><span style="color:#24292E;">: </span><span style="color:#032F62;">NoSchedule</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">containers</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">fluentd-elasticsearch</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">image</span><span style="color:#24292E;">: </span><span style="color:#032F62;">quay.io/fluentd_elasticsearch/fluentd:v2.5.2</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">resources</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">limits</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200Mi</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">requests</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">cpu</span><span style="color:#24292E;">: </span><span style="color:#032F62;">100m</span></span>
<span class="line"><span style="color:#24292E;">            </span><span style="color:#22863A;">memory</span><span style="color:#24292E;">: </span><span style="color:#032F62;">200Mi</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">volumeMounts</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">varlog</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">mountPath</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/log</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">terminationGracePeriodSeconds</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#22863A;">volumes</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">name</span><span style="color:#24292E;">: </span><span style="color:#032F62;">varlog</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">hostPath</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#22863A;">path</span><span style="color:#24292E;">: </span><span style="color:#032F62;">/var/log</span></span></code></pre></div><p>Create a DaemonSet based on the YAML file:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://k8s.io/examples/controllers/daemonset.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://k8s.io/examples/controllers/daemonset.yaml</span></span></code></pre></div><h3 id="required-fields" tabindex="-1">Required Fields <a class="header-anchor" href="#required-fields" aria-label="Permalink to &quot;Required Fields&quot;">​</a></h3><p>As with all other Kubernetes config, a DaemonSet needs <code>apiVersion</code>, <code>kind</code>, and <code>metadata</code> fields. For general information about working with config files, see <a href="https://kubernetes.io/docs/tasks/run-application/run-stateless-application-deployment/" target="_blank" rel="noreferrer">running stateless applications</a> and <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/" target="_blank" rel="noreferrer">object management using kubectl</a>.</p><p>The name of a DaemonSet object must be a valid <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/names#dns-subdomain-names" target="_blank" rel="noreferrer">DNS subdomain name</a>.</p><p>A DaemonSet also needs a <code>.spec</code> section.</p><h3 id="pod-template" tabindex="-1">Pod Template <a class="header-anchor" href="#pod-template" aria-label="Permalink to &quot;Pod Template&quot;">​</a></h3><p>The <code>.spec.template</code> is one of the required fields in <code>.spec</code>.</p><p>The <code>.spec.template</code> is a <a href="https://kubernetes.io/docs/concepts/workloads/pods/#pod-templates" target="_blank" rel="noreferrer">pod template</a>. It has exactly the same schema as a Pod, except it is nested and does not have an <code>apiVersion</code> or <code>kind</code>.</p><p>In addition to required fields for a Pod, a Pod template in a DaemonSet has to specify appropriate labels (see <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#pod-selector" target="_blank" rel="noreferrer">pod selector</a>).</p><p>A Pod Template in a DaemonSet must have a <code>RestartPolicy</code> equal to <code>Always</code>, or be unspecified, which defaults to <code>Always</code>.</p><h3 id="pod-selector" tabindex="-1">Pod Selector <a class="header-anchor" href="#pod-selector" aria-label="Permalink to &quot;Pod Selector&quot;">​</a></h3><p>The <code>.spec.selector</code> field is a pod selector. It works the same as the <code>.spec.selector</code> of a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/" target="_blank" rel="noreferrer">Job</a>.</p><p>You must specify a pod selector that matches the labels of the <code>.spec.template</code>. Also, once a DaemonSet is created, its <code>.spec.selector</code> can not be mutated. Mutating the pod selector can lead to the unintentional orphaning of Pods, and it was found to be confusing to users.</p><p>The <code>.spec.selector</code> is an object consisting of two fields:</p><ul><li><code>matchLabels</code> - works the same as the <code>.spec.selector</code> of a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/" target="_blank" rel="noreferrer">ReplicationController</a>.</li><li><code>matchExpressions</code> - allows to build more sophisticated selectors by specifying key, list of values and an operator that relates the key and values.</li></ul><p>When the two are specified the result is ANDed.</p><p>The <code>.spec.selector</code> must match the <code>.spec.template.metadata.labels</code>. Config with these two not matching will be rejected by the API.</p><h3 id="running-pods-on-select-nodes" tabindex="-1">Running Pods on select Nodes <a class="header-anchor" href="#running-pods-on-select-nodes" aria-label="Permalink to &quot;Running Pods on select Nodes&quot;">​</a></h3><p>If you specify a <code>.spec.template.spec.nodeSelector</code>, then the DaemonSet controller will create Pods on nodes which match that <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/" target="_blank" rel="noreferrer">node selector</a>. Likewise if you specify a <code>.spec.template.spec.affinity</code>, then DaemonSet controller will create Pods on nodes which match that <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/" target="_blank" rel="noreferrer">node affinity</a>. If you do not specify either, then the DaemonSet controller will create Pods on all nodes.</p><h2 id="how-daemon-pods-are-scheduled" tabindex="-1">How Daemon Pods are scheduled <a class="header-anchor" href="#how-daemon-pods-are-scheduled" aria-label="Permalink to &quot;How Daemon Pods are scheduled&quot;">​</a></h2><p>A DaemonSet ensures that all eligible nodes run a copy of a Pod. The DaemonSet controller creates a Pod for each eligible node and adds the <code>spec.affinity.nodeAffinity</code> field of the Pod to match the target host. After the Pod is created, the default scheduler typically takes over and then binds the Pod to the target host by setting the <code>.spec.nodeName</code> field. If the new Pod cannot fit on the node, the default scheduler may preempt (evict) some of the existing Pods based on the <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/#pod-priority" target="_blank" rel="noreferrer">priority</a> of the new Pod.</p><p>The user can specify a different scheduler for the Pods of the DaemonSet, by setting the <code>.spec.template.spec.schedulerName</code> field of the DaemonSet.</p><p>The original node affinity specified at the <code>.spec.template.spec.affinity.nodeAffinity</code> field (if specified) is taken into consideration by the DaemonSet controller when evaluating the eligible nodes, but is replaced on the created Pod with the node affinity that matches the name of the eligible node.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">nodeAffinity</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#85E89D;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#85E89D;">nodeSelectorTerms</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">matchFields</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">      - </span><span style="color:#85E89D;">key</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">metadata.name</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">operator</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">In</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#85E89D;">values</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        - </span><span style="color:#9ECBFF;">target-host-name</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">nodeAffinity</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#22863A;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#22863A;">nodeSelectorTerms</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">    - </span><span style="color:#22863A;">matchFields</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">      - </span><span style="color:#22863A;">key</span><span style="color:#24292E;">: </span><span style="color:#032F62;">metadata.name</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">operator</span><span style="color:#24292E;">: </span><span style="color:#032F62;">In</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#22863A;">values</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        - </span><span style="color:#032F62;">target-host-name</span></span></code></pre></div><h3 id="taints-and-tolerations" tabindex="-1">Taints and tolerations <a class="header-anchor" href="#taints-and-tolerations" aria-label="Permalink to &quot;Taints and tolerations&quot;">​</a></h3><p>The DaemonSet controller automatically adds a set of tolerations to DaemonSet Pods:</p><table><thead><tr><th>Toleration key</th><th>Effect</th><th>Details</th></tr></thead><tbody><tr><td>node.kubernetes.io/not-ready</td><td>NoExecute</td><td>DaemonSet Pods can be scheduled onto nodes that are not healthy or ready to accept Pods. Any DaemonSet Pods running on such nodes will not be evicted.</td></tr><tr><td>node.kubernetes.io/unreachable</td><td>NoExecute</td><td>DaemonSet Pods can be scheduled onto nodes that are unreachable from the node controller. Any DaemonSet Pods running on such nodes will not be evicted.</td></tr><tr><td>node.kubernetes.io/disk-pressure</td><td>NoSchedule</td><td>DaemonSet Pods can be scheduled onto nodes with disk pressure issues.</td></tr><tr><td>node.kubernetes.io/memory-pressure</td><td>NoSchedule</td><td>DaemonSet Pods can be scheduled onto nodes with memory pressure issues.</td></tr><tr><td>node.kubernetes.io/pid-pressure</td><td>NoSchedule</td><td>DaemonSet Pods can be scheduled onto nodes with process pressure issues.</td></tr><tr><td>node.kubernetes.io/unschedulable</td><td>NoSchedule</td><td>DaemonSet Pods can be scheduled onto nodes that are unschedulable.</td></tr><tr><td>node.kubernetes.io/network-unavailable</td><td>NoSchedule</td><td>Only added for DaemonSet Pods that request host networking, i.e., Pods having spec.hostNetwork: true. Such DaemonSet Pods can be scheduled onto nodes with unavailable network.</td></tr></tbody></table><p>You can add your own tolerations to the Pods of a DaemonSet as well, by defining these in the Pod template of the DaemonSet.</p><p>Because the DaemonSet controller sets the <code>node.kubernetes.io/unschedulable:NoSchedule</code> toleration automatically, Kubernetes can run DaemonSet Pods on nodes that are marked as unschedulable.</p><p>If you use a DaemonSet to provide an important node-level function, such as <a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/" target="_blank" rel="noreferrer">cluster networking</a>, it is helpful that Kubernetes places DaemonSet Pods on nodes before they are ready. For example, without that special toleration, you could end up in a deadlock situation where the node is not marked as ready because the network plugin is not running there, and at the same time the network plugin is not running on that node because the node is not yet ready.</p><h2 id="communicating-with-daemon-pods" tabindex="-1">Communicating with Daemon Pods <a class="header-anchor" href="#communicating-with-daemon-pods" aria-label="Permalink to &quot;Communicating with Daemon Pods&quot;">​</a></h2><p>Some possible patterns for communicating with Pods in a DaemonSet are:</p><ul><li><strong>Push</strong>: Pods in the DaemonSet are configured to send updates to another service, such as a stats database. They do not have clients.</li><li><strong>NodeIP and Known Port</strong>: Pods in the DaemonSet can use a <code>hostPort</code>, so that the pods are reachable via the node IPs. Clients know the list of node IPs somehow, and know the port by convention.</li><li><strong>DNS</strong>: Create a <a href="https://kubernetes.io/docs/concepts/services-networking/service/#headless-services" target="_blank" rel="noreferrer">headless service</a> with the same pod selector, and then discover DaemonSets using the <code>endpoints</code> resource or retrieve multiple A records from DNS.</li><li><strong>Service</strong>: Create a service with the same Pod selector, and use the service to reach a daemon on a random node. (No way to reach specific node.)</li></ul><h2 id="updating-a-daemonset" tabindex="-1">Updating a DaemonSet <a class="header-anchor" href="#updating-a-daemonset" aria-label="Permalink to &quot;Updating a DaemonSet&quot;">​</a></h2><p>If node labels are changed, the DaemonSet will promptly add Pods to newly matching nodes and delete Pods from newly not-matching nodes.</p><p>You can modify the Pods that a DaemonSet creates. However, Pods do not allow all fields to be updated. Also, the DaemonSet controller will use the original template the next time a node (even with the same name) is created.</p><p>You can delete a DaemonSet. If you specify <code>--cascade=orphan</code> with <code>kubectl</code>, then the Pods will be left on the nodes. If you subsequently create a new DaemonSet with the same selector, the new DaemonSet adopts the existing Pods. If any Pods need replacing the DaemonSet replaces them according to its <code>updateStrategy</code>.</p><p>You can <a href="https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/" target="_blank" rel="noreferrer">perform a rolling update</a> on a DaemonSet.</p><h2 id="alternatives-to-daemonset" tabindex="-1">Alternatives to DaemonSet <a class="header-anchor" href="#alternatives-to-daemonset" aria-label="Permalink to &quot;Alternatives to DaemonSet&quot;">​</a></h2><h3 id="init-scripts" tabindex="-1">Init scripts <a class="header-anchor" href="#init-scripts" aria-label="Permalink to &quot;Init scripts&quot;">​</a></h3><p>It is certainly possible to run daemon processes by directly starting them on a node (e.g. using <code>init</code>, <code>upstartd</code>, or <code>systemd</code>). This is perfectly fine. However, there are several advantages to running such processes via a DaemonSet:</p><ul><li>Ability to monitor and manage logs for daemons in the same way as applications.</li><li>Same config language and tools (e.g. Pod templates, <code>kubectl</code>) for daemons and applications.</li><li>Running daemons in containers with resource limits increases isolation between daemons from app containers. However, this can also be accomplished by running the daemons in a container but not in a Pod.</li></ul><h3 id="bare-pods" tabindex="-1">Bare Pods <a class="header-anchor" href="#bare-pods" aria-label="Permalink to &quot;Bare Pods&quot;">​</a></h3><p>It is possible to create Pods directly which specify a particular node to run on. However, a DaemonSet replaces Pods that are deleted or terminated for any reason, such as in the case of node failure or disruptive node maintenance, such as a kernel upgrade. For this reason, you should use a DaemonSet rather than creating individual Pods.</p><h3 id="static-pods" tabindex="-1">Static Pods <a class="header-anchor" href="#static-pods" aria-label="Permalink to &quot;Static Pods&quot;">​</a></h3><p>It is possible to create Pods by writing a file to a certain directory watched by Kubelet. These are called <a href="https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/" target="_blank" rel="noreferrer">static pods</a>. Unlike DaemonSet, static Pods cannot be managed with kubectl or other Kubernetes API clients. Static Pods do not depend on the apiserver, making them useful in cluster bootstrapping cases. Also, static Pods may be deprecated in the future.</p><h3 id="deployments" tabindex="-1">Deployments <a class="header-anchor" href="#deployments" aria-label="Permalink to &quot;Deployments&quot;">​</a></h3><p>DaemonSets are similar to <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noreferrer">Deployments</a> in that they both create Pods, and those Pods have processes which are not expected to terminate (e.g. web servers, storage servers).</p><p>Use a Deployment for stateless services, like frontends, where scaling up and down the number of replicas and rolling out updates are more important than controlling exactly which host the Pod runs on. Use a DaemonSet when it is important that a copy of a Pod always run on all or certain hosts, if the DaemonSet provides node-level functionality that allows other Pods to run correctly on that particular node.</p><p>For example, <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" target="_blank" rel="noreferrer">network plugins</a> often include a component that runs as a DaemonSet. The DaemonSet component makes sure that the node where it&#39;s running has working cluster networking.</p><h2 id="what-s-next" tabindex="-1">What&#39;s next <a class="header-anchor" href="#what-s-next" aria-label="Permalink to &quot;What&#39;s next&quot;">​</a></h2><ul><li><p>Learn about <a href="https://kubernetes.io/docs/concepts/workloads/pods" target="_blank" rel="noreferrer">Pods</a>.</p><ul><li>Learn about <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/#static-pods" target="_blank" rel="noreferrer">static Pods</a>, which are useful for running Kubernetes control plane components.</li></ul></li><li><p>Find out how to use DaemonSets</p><ul><li><a href="https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/" target="_blank" rel="noreferrer">Perform a rolling update on a DaemonSet</a></li><li><a href="https://kubernetes.io/docs/tasks/manage-daemon/rollback-daemon-set/" target="_blank" rel="noreferrer">Perform a rollback on a DaemonSet</a> (for example, if a roll out didn&#39;t work how you expected).</li></ul></li><li><p>Understand <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/" target="_blank" rel="noreferrer">how Kubernetes assigns Pods to Nodes</a>.</p></li><li><p>Learn about <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/" target="_blank" rel="noreferrer">device plugins</a> and <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noreferrer">add ons</a>, which often run as DaemonSets.</p></li><li><p><code>DaemonSet</code> is a top-level resource in the Kubernetes REST API. Read the <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/daemon-set-v1/" target="_blank" rel="noreferrer">DaemonSet</a> object definition to understand the API for daemon sets.</p></li></ul>`,62),l=[t];function p(r,c,i,d,h,y){return s(),a("div",null,l)}const m=e(o,[["render",p]]);export{u as __pageData,m as default};
