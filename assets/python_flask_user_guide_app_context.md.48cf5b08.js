import{_ as s,o as a,c as e,Q as n}from"./chunks/framework.01af844e.js";const E=JSON.parse('{"title":"The Application Context","description":"","frontmatter":{},"headers":[],"relativePath":"python/flask/user_guide/app_context.md","filePath":"python/flask/user_guide/app_context.md","lastUpdated":1693328004000}'),o={name:"python/flask/user_guide/app_context.md"},t=n(`<h1 id="the-application-context" tabindex="-1">The Application Context <a class="header-anchor" href="#the-application-context" aria-label="Permalink to &quot;The Application Context {#the-application-context}&quot;">​</a></h1><p>The application context keeps track of the application-level data during a request, CLI command, or other activity. Rather than passing the application around to each function, the <code>current_app</code> and g proxies are accessed instead.</p><p>This is similar to <a href="/python/flask/user_guide/request_context#the-request-context">The Request Context</a>, which keeps track of request-level data during a request. A corresponding application context is pushed when a request context is pushed.</p><h2 id="purpose-of-the-context" tabindex="-1">Purpose of the Context <a class="header-anchor" href="#purpose-of-the-context" aria-label="Permalink to &quot;Purpose of the Context {#purpose-of-the-context}&quot;">​</a></h2><p>The <code>Flask</code> application object has attributes, such as <code>config</code>, that are useful to access within views and <a href="/python/flask/user_guide/cmd_interface#command-line-interface">CLI commands</a>. However, importing the <code>app</code> instance within the modules in your project is prone to circular import issues. When using the <a href="/python/flask/user_guide/pattern/app_factories#application-factories">app factory pattern</a> or writing reusable <a href="/python/flask/user_guide/blueprint#modular-applications-with-blueprints">blueprints</a> or <a href="/python/flask/user_guide/extension#extensions">extensions</a> there won’t be an <code>app</code> instance to import at all.</p><p>Flask solves this issue with the application context. Rather than referring to an <code>app</code> directly, you use the <code>current_app</code> proxy, which points to the application handling the current activity.</p><p>Flask automatically pushes an application context when handling a request. View functions, error handlers, and other functions that run during a request will have access to <code>current_app</code>.</p><p>Flask will also automatically push an app context when running CLI commands registered with <code>Flask.cli</code> using <code>@app.cli.command()</code>.</p><h2 id="lifetime-of-the-context" tabindex="-1">Lifetime of the Context <a class="header-anchor" href="#lifetime-of-the-context" aria-label="Permalink to &quot;Lifetime of the Context {#lifetime-of-the-context}&quot;">​</a></h2><p>The application context is created and destroyed as necessary. When a Flask application begins handling a request, it pushes an application context and a <a href="/python/flask/user_guide/request_context#the-request-context">request context</a>. When the request ends it pops the request context then the application context. Typically, an application context will have the same lifetime as a request.</p><p>See <a href="/python/flask/user_guide/request_context#the-request-context">The Request Context</a> for more information about how the contexts work and the full life cycle of a request.</p><h2 id="manually-push-a-context" tabindex="-1">Manually Push a Context <a class="header-anchor" href="#manually-push-a-context" aria-label="Permalink to &quot;Manually Push a Context {#manually-push-a-context}&quot;">​</a></h2><p>If you try to access <code>current_app</code>, or anything that uses it, outside an application context, you’ll get this error message:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">RuntimeError: Working outside of application context.</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">This typically means that you attempted to use functionality that</span></span>
<span class="line"><span style="color:#e1e4e8;">needed to interface with the current application object in some way.</span></span>
<span class="line"><span style="color:#e1e4e8;">To solve this, set up an application context with app.app_context().</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">RuntimeError: Working outside of application context.</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">This typically means that you attempted to use functionality that</span></span>
<span class="line"><span style="color:#24292e;">needed to interface with the current application object in some way.</span></span>
<span class="line"><span style="color:#24292e;">To solve this, set up an application context with app.app_context().</span></span></code></pre></div><p>If you see that error while configuring your application, such as when initializing an extension, you can push a context manually since you have direct access to the <code>app</code>. Use <code>app_context()</code> in a <code>with</code> block, and everything that runs in the block will have access to <code>current_app</code>.</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">create_app</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    app </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Flask(</span><span style="color:#79B8FF;">__name__</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> app.app_context():</span></span>
<span class="line"><span style="color:#E1E4E8;">        init_db()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> app</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">create_app</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    app </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Flask(</span><span style="color:#005CC5;">__name__</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">with</span><span style="color:#24292E;"> app.app_context():</span></span>
<span class="line"><span style="color:#24292E;">        init_db()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> app</span></span></code></pre></div><p>If you see that error somewhere else in your code not related to configuring the application, it most likely indicates that you should move that code into a view function or CLI command.</p><h2 id="storing-data" tabindex="-1">Storing Data <a class="header-anchor" href="#storing-data" aria-label="Permalink to &quot;Storing Data {#storing-data}&quot;">​</a></h2><p>The application context is a good place to store common data during a request or CLI command. Flask provides the <code>g</code> object for this purpose. It is a simple namespace object that has the same lifetime as an application context.</p><div class="tip custom-block"><p class="custom-block-title">Note</p><p>The g name stands for “global”, but that is referring to the data being global within a context. The data on g is lost after the context ends, and it is not an appropriate place to store data between requests. Use the session or a database to store data across requests.</p></div><p>A common use for g is to manage resources during a request.</p><ol><li><p><code>get_X()</code> creates resource X if it does not exist, caching it as <code>g.X</code>.</p></li><li><p><code>teardown_X()</code> closes or otherwise deallocates the resource if it exists. It is registered as a <code>teardown_appcontext()</code> handler.</p></li></ol><p>For example, you can manage a database connection using this pattern:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flask </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> g</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">get_db</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;db&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">in</span><span style="color:#E1E4E8;"> g:</span></span>
<span class="line"><span style="color:#E1E4E8;">        g.db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> connect_to_database()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> g.db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">@app.teardown_appcontext</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">teardown_db</span><span style="color:#E1E4E8;">(exception):</span></span>
<span class="line"><span style="color:#E1E4E8;">    db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> g.pop(</span><span style="color:#9ECBFF;">&#39;db&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> db </span><span style="color:#F97583;">is</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">not</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">None</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        db.close()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flask </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> g</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">get_db</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;db&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">in</span><span style="color:#24292E;"> g:</span></span>
<span class="line"><span style="color:#24292E;">        g.db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> connect_to_database()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> g.db</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">@app.teardown_appcontext</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">teardown_db</span><span style="color:#24292E;">(exception):</span></span>
<span class="line"><span style="color:#24292E;">    db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> g.pop(</span><span style="color:#032F62;">&#39;db&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> db </span><span style="color:#D73A49;">is</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">not</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">None</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        db.close()</span></span></code></pre></div><p>During a request, every call to <code>get_db()</code> will return the same connection, and it will be closed automatically at the end of the request.</p><p>You can use <code>LocalProxy</code> to make a new context local from <code>get_db()</code>:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> werkzeug.local </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> LocalProxy</span></span>
<span class="line"><span style="color:#E1E4E8;">db </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> LocalProxy(get_db)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> werkzeug.local </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> LocalProxy</span></span>
<span class="line"><span style="color:#24292E;">db </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> LocalProxy(get_db)</span></span></code></pre></div><p>Accessing <code>db</code> will call <code>get_db</code> internally, in the same way that <code>current_app</code> works.</p><h2 id="events-and-signals" tabindex="-1">Events and Signals <a class="header-anchor" href="#events-and-signals" aria-label="Permalink to &quot;Events and Signals {#events-and-signals}&quot;">​</a></h2><p>The application will call functions registered with <code>teardown_appcontext()</code> when the application context is popped.</p><p>The following signals are sent: <code>appcontext_pushed</code>, <code>appcontext_tearing_down</code>, and <code>appcontext_popped</code>.</p>`,31),p=[t];function l(c,i,r,d,h,y){return a(),e("div",null,p)}const g=s(o,[["render",l]]);export{E as __pageData,g as default};
