import{_ as e,o as t,c as s,Q as a}from"./chunks/framework.01af844e.js";const f=JSON.parse('{"title":"Configuring each kubelet in your cluster using kubeadm","description":"","frontmatter":{},"headers":[],"relativePath":"golang/k8s/get_started/prod_env/install/bootstrap/configure_kubelet.md","filePath":"golang/k8s/get_started/prod_env/install/bootstrap/configure_kubelet.md","lastUpdated":1693758126000}'),n={name:"golang/k8s/get_started/prod_env/install/bootstrap/configure_kubelet.md"},o=a(`<h1 id="configuring-each-kubelet-in-your-cluster-using-kubeadm" tabindex="-1">Configuring each kubelet in your cluster using kubeadm <a class="header-anchor" href="#configuring-each-kubelet-in-your-cluster-using-kubeadm" aria-label="Permalink to &quot;Configuring each kubelet in your cluster using kubeadm&quot;">​</a></h1><div class="tip custom-block"><p class="custom-block-title">Note:</p><p>Dockershim has been removed from the Kubernetes project as of release 1.24. Read the <a href="https://kubernetes.io/dockershim" target="_blank" rel="noreferrer">Dockershim Removal FAQ</a> for further details.</p></div><p><em>FEATURE STATE</em>: <code>Kubernetes v1.11 [stable]</code></p><p>The lifecycle of the kubeadm CLI tool is decoupled from the <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet" target="_blank" rel="noreferrer">kubelet</a>, which is a daemon that runs on each node within the Kubernetes cluster. The kubeadm CLI tool is executed by the user when Kubernetes is initialized or upgraded, whereas the kubelet is always running in the background.</p><p>Since the kubelet is a daemon, it needs to be maintained by some kind of an init system or service manager. When the kubelet is installed using DEBs or RPMs, systemd is configured to manage the kubelet. You can use a different service manager instead, but you need to configure it manually.</p><p>Some kubelet configuration details need to be the same across all kubelets involved in the cluster, while other configuration aspects need to be set on a per-kubelet basis to accommodate the different characteristics of a given machine (such as OS, storage, and networking). You can manage the configuration of your kubelets manually, but kubeadm now provides a <code>KubeletConfiguration</code> API type for <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#configure-kubelets-using-kubeadm" target="_blank" rel="noreferrer">managing your kubelet configurations centrally</a>.</p><h2 id="kubelet-configuration-patterns" tabindex="-1">Kubelet configuration patterns <a class="header-anchor" href="#kubelet-configuration-patterns" aria-label="Permalink to &quot;Kubelet configuration patterns&quot;">​</a></h2><p>The following sections describe patterns to kubelet configuration that are simplified by using kubeadm, rather than managing the kubelet configuration for each Node manually.</p><h3 id="propagating-cluster-level-configuration-to-each-kubelet" tabindex="-1">Propagating cluster-level configuration to each kubelet <a class="header-anchor" href="#propagating-cluster-level-configuration-to-each-kubelet" aria-label="Permalink to &quot;Propagating cluster-level configuration to each kubelet&quot;">​</a></h3><p>You can provide the kubelet with default values to be used by <code>kubeadm init</code> and <code>kubeadm join</code> commands. Interesting examples include using a different container runtime or setting the default subnet used by services.</p><p>If you want your services to use the subnet <code>10.96.0.0/12</code> as the default for services, you can pass the <code>--service-cidr</code> parameter to kubeadm:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--service-cidr</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10.96</span><span style="color:#9ECBFF;">.0.0/12</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--service-cidr</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10.96</span><span style="color:#032F62;">.0.0/12</span></span></code></pre></div><p>Virtual IPs for services are now allocated from this subnet. You also need to set the DNS address used by the kubelet, using the <code>--cluster-dns</code> flag. This setting needs to be the same for every kubelet on every manager and Node in the cluster. The kubelet provides a versioned, structured API object that can configure most parameters in the kubelet and push out this configuration to each running kubelet in the cluster. This object is called <a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/" target="_blank" rel="noreferrer">KubeletConfiguration</a>. The <code>KubeletConfiguration</code> allows the user to specify flags such as the cluster DNS IP addresses expressed as a list of values to a camelCased key, illustrated by the following example:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#85E89D;">clusterDNS</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">- </span><span style="color:#79B8FF;">10.96.0.10</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#22863A;">apiVersion</span><span style="color:#24292E;">: </span><span style="color:#032F62;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#22863A;">kind</span><span style="color:#24292E;">: </span><span style="color:#032F62;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#22863A;">clusterDNS</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">- </span><span style="color:#005CC5;">10.96.0.10</span></span></code></pre></div><p>For more details on the <code>KubeletConfiguration</code> have a look at <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#configure-kubelets-using-kubeadm" target="_blank" rel="noreferrer">this section</a>.</p><h3 id="providing-instance-specific-configuration-details" tabindex="-1">Providing instance-specific configuration details <a class="header-anchor" href="#providing-instance-specific-configuration-details" aria-label="Permalink to &quot;Providing instance-specific configuration details&quot;">​</a></h3><p>Some hosts require specific kubelet configurations due to differences in hardware, operating system, networking, or other host-specific parameters. The following list provides a few examples.</p><ul><li><p>The path to the DNS resolution file, as specified by the <code>--resolv-conf</code> kubelet configuration flag, may differ among operating systems, or depending on whether you are using <code>systemd-resolved</code>. If this path is wrong, DNS resolution will fail on the Node whose kubelet is configured incorrectly.</p></li><li><p>The Node API object <code>.metadata.name</code> is set to the machine&#39;s hostname by default, unless you are using a cloud provider. You can use the <code>--hostname-override</code> flag to override the default behavior if you need to specify a Node name different from the machine&#39;s hostname.</p></li><li><p>Currently, the kubelet cannot automatically detect the cgroup driver used by the container runtime, but the value of <code>--cgroup-driver</code> must match the cgroup driver used by the container runtime to ensure the health of the kubelet.</p></li><li><p>To specify the container runtime you must set its endpoint with the <code>--container-runtime-endpoint=&lt;path&gt;</code> flag.</p></li></ul><p>The recommended way of applying such instance-specific configuration is by using <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/control-plane-flags#patches" target="_blank" rel="noreferrer">KubeletConfiguration patches</a>.</p><h2 id="configure-kubelets-using-kubeadm" tabindex="-1">Configure kubelets using kubeadm <a class="header-anchor" href="#configure-kubelets-using-kubeadm" aria-label="Permalink to &quot;Configure kubelets using kubeadm&quot;">​</a></h2><p>It is possible to configure the kubelet that kubeadm will start if a custom <a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/" target="_blank" rel="noreferrer">KubeletConfiguration</a> API object is passed with a configuration file like so <code>kubeadm ... --config some-config-file.yaml</code>.</p><p>By calling <code>kubeadm config print init-defaults --component-configs KubeletConfiguration</code> you can see all the default values for this structure.</p><p>It is also possible to apply instance-specific patches over the base <code>KubeletConfiguration</code>. Have a look at <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/control-plane-flags#customizing-the-kubelet" target="_blank" rel="noreferrer">Customizing the kubelet</a> for more details.</p><h3 id="workflow-when-using-kubeadm-init" tabindex="-1">Workflow when using <code>kubeadm init</code> <a class="header-anchor" href="#workflow-when-using-kubeadm-init" aria-label="Permalink to &quot;Workflow when using \`kubeadm init\`&quot;">​</a></h3><p>When you call <code>kubeadm init</code>, the kubelet configuration is marshalled to disk at <code>/var/lib/kubelet/config.yaml</code>, and also uploaded to a <code>kubelet-config</code> ConfigMap in the <code>kube-system</code> namespace of the cluster. A kubelet configuration file is also written to <code>/etc/kubernetes/kubelet.conf</code> with the baseline cluster-wide configuration for all kubelets in the cluster. This configuration file points to the client certificates that allow the kubelet to communicate with the API server. This addresses the need to <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#propagating-cluster-level-configuration-to-each-kubelet" target="_blank" rel="noreferrer">propagate cluster-level configuration to each kubelet</a>.</p><p>To address the second pattern of <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#providing-instance-specific-configuration-details" target="_blank" rel="noreferrer">providing instance-specific configuration details</a>, kubeadm writes an environment file to <code>/var/lib/kubelet/kubeadm-flags.env</code>, which contains a list of flags to pass to the kubelet when it starts. The flags are presented in the file like this:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">KUBELET_KUBEADM_ARGS</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;--flag1=value1 --flag2=value2 ...&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">KUBELET_KUBEADM_ARGS</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&quot;--flag1=value1 --flag2=value2 ...&quot;</span></span></code></pre></div><p>In addition to the flags used when starting the kubelet, the file also contains dynamic parameters such as the cgroup driver and whether to use a different container runtime socket (<code>--cri-socket</code>).</p><p>After marshalling these two files to disk, kubeadm attempts to run the following two commands, if you are using systemd:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><p>If the reload and restart are successful, the normal <code>kubeadm init</code> workflow continues.</p><h3 id="workflow-when-using-kubeadm-join" tabindex="-1">Workflow when using <code>kubeadm join</code> <a class="header-anchor" href="#workflow-when-using-kubeadm-join" aria-label="Permalink to &quot;Workflow when using \`kubeadm join\`&quot;">​</a></h3><p>When you run <code>kubeadm join</code>, kubeadm uses the Bootstrap Token credential to perform a TLS bootstrap, which fetches the credential needed to download the <code>kubelet-config</code> ConfigMap and writes it to <code>/var/lib/kubelet/config.yaml</code>. The dynamic environment file is generated in exactly the same way as <code>kubeadm init</code>.</p><p>Next, <code>kubeadm</code> runs the following two commands to load the new configuration into the kubelet:</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">daemon-reload</span><span style="color:#E1E4E8;"> &amp;&amp; </span><span style="color:#B392F0;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">restart</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubelet</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">daemon-reload</span><span style="color:#24292E;"> &amp;&amp; </span><span style="color:#6F42C1;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">restart</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubelet</span></span></code></pre></div><p>After the kubelet loads the new configuration, kubeadm writes the <code>/etc/kubernetes/bootstrap-kubelet.conf</code> KubeConfig file, which contains a CA certificate and Bootstrap Token. These are used by the kubelet to perform the TLS Bootstrap and obtain a unique credential, which is stored in <code>/etc/kubernetes/kubelet.conf</code>.</p><p>When the <code>/etc/kubernetes/kubelet.conf</code> file is written, the kubelet has finished performing the TLS Bootstrap. Kubeadm deletes the <code>/etc/kubernetes/bootstrap-kubelet.conf</code> file after completing the TLS Bootstrap.</p><h2 id="the-kubelet-drop-in-file-for-systemd" tabindex="-1">The kubelet drop-in file for systemd <a class="header-anchor" href="#the-kubelet-drop-in-file-for-systemd" aria-label="Permalink to &quot;The kubelet drop-in file for systemd&quot;">​</a></h2><p><code>kubeadm</code> ships with configuration for how systemd should run the kubelet. Note that the kubeadm CLI command never touches this drop-in file.</p><p>This configuration file installed by the <code>kubeadm</code> <a href="https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf" target="_blank" rel="noreferrer">DEB</a> or <a href="https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/rpm/kubeadm/10-kubeadm.conf" target="_blank" rel="noreferrer">RPM package</a> is written to <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> and is used by systemd. It augments the basic <a href="https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/rpm/kubelet/kubelet.service" target="_blank" rel="noreferrer">kubelet.service for RPM</a> or <a href="https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service" target="_blank" rel="noreferrer">kubelet.service for DEB</a>:</p><div class="tip custom-block"><p class="custom-block-title">Note:</p><p>The contents below are just an example. If you don&#39;t want to use a package manager follow the guide outlined in the (<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2" target="_blank" rel="noreferrer">Without a package manager</a>) section.</p></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">[Service]</span></span>
<span class="line"><span style="color:#e1e4e8;">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generate at runtime, populating</span></span>
<span class="line"><span style="color:#e1e4e8;"># the KUBELET_KUBEADM_ARGS variable dynamically</span></span>
<span class="line"><span style="color:#e1e4e8;">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span></span>
<span class="line"><span style="color:#e1e4e8;"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably,</span></span>
<span class="line"><span style="color:#e1e4e8;"># the user should use the .NodeRegistration.KubeletExtraArgs object in the configuration files instead.</span></span>
<span class="line"><span style="color:#e1e4e8;"># KUBELET_EXTRA_ARGS should be sourced from this file.</span></span>
<span class="line"><span style="color:#e1e4e8;">EnvironmentFile=-/etc/default/kubelet</span></span>
<span class="line"><span style="color:#e1e4e8;">ExecStart=</span></span>
<span class="line"><span style="color:#e1e4e8;">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">[Service]</span></span>
<span class="line"><span style="color:#24292e;">Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;</span></span>
<span class="line"><span style="color:#24292e;">Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span></span>
<span class="line"><span style="color:#24292e;"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generate at runtime, populating</span></span>
<span class="line"><span style="color:#24292e;"># the KUBELET_KUBEADM_ARGS variable dynamically</span></span>
<span class="line"><span style="color:#24292e;">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span></span>
<span class="line"><span style="color:#24292e;"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably,</span></span>
<span class="line"><span style="color:#24292e;"># the user should use the .NodeRegistration.KubeletExtraArgs object in the configuration files instead.</span></span>
<span class="line"><span style="color:#24292e;"># KUBELET_EXTRA_ARGS should be sourced from this file.</span></span>
<span class="line"><span style="color:#24292e;">EnvironmentFile=-/etc/default/kubelet</span></span>
<span class="line"><span style="color:#24292e;">ExecStart=</span></span>
<span class="line"><span style="color:#24292e;">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</span></span></code></pre></div><p>This file specifies the default locations for all of the files managed by kubeadm for the kubelet.</p><ul><li>The KubeConfig file to use for the TLS Bootstrap is <code>/etc/kubernetes/bootstrap-kubelet.conf</code>, but it is only used if <code>/etc/kubernetes/kubelet.conf</code> does not exist.</li><li>The KubeConfig file with the unique kubelet identity is <code>/etc/kubernetes/kubelet.conf</code>.</li><li>The file containing the kubelet&#39;s ComponentConfig is <code>/var/lib/kubelet/config.yaml</code>.</li><li>The dynamic environment file that contains <code>KUBELET_KUBEADM_ARGS</code> is sourced from <code>/var/lib/kubelet/kubeadm-flags.env</code>.</li><li>The file that can contain user-specified flag overrides with <code>KUBELET_EXTRA_ARGS</code> is sourced from <code>/etc/default/kubelet</code> (for DEBs), or <code>/etc/sysconfig/kubelet</code> (for RPMs). <code>KUBELET_EXTRA_ARGS</code> is last in the flag chain and has the highest priority in the event of conflicting settings.</li></ul><h2 id="kubernetes-binaries-and-package-contents" tabindex="-1">Kubernetes binaries and package contents <a class="header-anchor" href="#kubernetes-binaries-and-package-contents" aria-label="Permalink to &quot;Kubernetes binaries and package contents&quot;">​</a></h2><p>The DEB and RPM packages shipped with the Kubernetes releases are:</p><table><thead><tr><th>Package name</th><th>Description</th></tr></thead><tbody><tr><td>kubeadm</td><td>Installs the <code>/usr/bin/kubeadm</code> CLI tool and the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/#the-kubelet-drop-in-file-for-systemd" target="_blank" rel="noreferrer">kubelet drop-in file</a> for the kubelet.</td></tr><tr><td>kubelet</td><td>Installs the <code>/usr/bin/kubelet</code> binary.</td></tr><tr><td>kubectl</td><td>Installs the <code>/usr/bin/kubectl</code> binary.</td></tr><tr><td>cri-tools</td><td>Installs the <code>/usr/bin/crictl</code> binary from the <a href="https://github.com/kubernetes-sigs/cri-tools" target="_blank" rel="noreferrer">cri-tools git repository</a>.</td></tr><tr><td>kubernetes-cni</td><td>Installs the <code>/opt/cni/bin</code> binaries from the <a href="https://github.com/containernetworking/plugins" target="_blank" rel="noreferrer">plugins git repository</a>.</td></tr></tbody></table>`,47),l=[o];function i(r,c,u,p,d,h){return t(),s("div",null,l)}const k=e(n,[["render",i]]);export{f as __pageData,k as default};
