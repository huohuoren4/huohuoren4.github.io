import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.01af844e.js";const d=JSON.parse('{"title":"Request Content Checksums","description":"","frontmatter":{},"headers":[],"relativePath":"python/flask/user_guide/pattern/checksum.md","filePath":"python/flask/user_guide/pattern/checksum.md","lastUpdated":1692979908000}'),p={name:"python/flask/user_guide/pattern/checksum.md"},e=l(`<h1 id="request-content-checksums" tabindex="-1">Request Content Checksums <a class="header-anchor" href="#request-content-checksums" aria-label="Permalink to &quot;Request Content Checksums {#request-content-checksums}&quot;">â€‹</a></h1><p>Various pieces of code can consume the request data and preprocess it. For instance JSON data ends up on the request object already read and processed, form data ends up there as well but goes through a different code path. This seems inconvenient when you want to calculate the checksum of the incoming request data. This is necessary sometimes for some APIs.</p><p>Fortunately this is however very simple to change by wrapping the input stream.</p><p>The following example calculates the SHA1 checksum of the incoming data as it gets read and stores it in the WSGI environment:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> hashlib</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ChecksumCalcStream</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">object</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">__init__</span><span style="color:#E1E4E8;">(self, stream):</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">._stream </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stream</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">._hash </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> hashlib.sha1()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">read</span><span style="color:#E1E4E8;">(self, bytes):</span></span>
<span class="line"><span style="color:#E1E4E8;">        rv </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">._stream.read(</span><span style="color:#79B8FF;">bytes</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">._hash.update(rv)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> rv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">readline</span><span style="color:#E1E4E8;">(self, size_hint):</span></span>
<span class="line"><span style="color:#E1E4E8;">        rv </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">._stream.readline(size_hint)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">._hash.update(rv)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> rv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">generate_checksum</span><span style="color:#E1E4E8;">(request):</span></span>
<span class="line"><span style="color:#E1E4E8;">    env </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.environ</span></span>
<span class="line"><span style="color:#E1E4E8;">    stream </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ChecksumCalcStream(env[</span><span style="color:#9ECBFF;">&#39;wsgi.input&#39;</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    env[</span><span style="color:#9ECBFF;">&#39;wsgi.input&#39;</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> stream</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> stream._hash</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> hashlib</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ChecksumCalcStream</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">object</span><span style="color:#24292E;">):</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">__init__</span><span style="color:#24292E;">(self, stream):</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._stream </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stream</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._hash </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> hashlib.sha1()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">read</span><span style="color:#24292E;">(self, bytes):</span></span>
<span class="line"><span style="color:#24292E;">        rv </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._stream.read(</span><span style="color:#005CC5;">bytes</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._hash.update(rv)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> rv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">readline</span><span style="color:#24292E;">(self, size_hint):</span></span>
<span class="line"><span style="color:#24292E;">        rv </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._stream.readline(size_hint)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">self</span><span style="color:#24292E;">._hash.update(rv)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> rv</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">generate_checksum</span><span style="color:#24292E;">(request):</span></span>
<span class="line"><span style="color:#24292E;">    env </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> request.environ</span></span>
<span class="line"><span style="color:#24292E;">    stream </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ChecksumCalcStream(env[</span><span style="color:#032F62;">&#39;wsgi.input&#39;</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    env[</span><span style="color:#032F62;">&#39;wsgi.input&#39;</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> stream</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> stream._hash</span></span></code></pre></div><p>To use this, all you need to do is to hook the calculating stream in before the request starts consuming data. (Eg: be careful accessing <code>request.form</code> or anything of that nature. <code>before_request_handlers</code> for instance should be careful not to access it).</p><p>Example usage:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">@app.route</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;/special-api&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">methods</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">[</span><span style="color:#9ECBFF;">&#39;POST&#39;</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">special_api</span><span style="color:#E1E4E8;">():</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">hash</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> generate_checksum(request)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># Accessing this parses the input stream</span></span>
<span class="line"><span style="color:#E1E4E8;">    files </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> request.files</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># At this point the hash is fully constructed.</span></span>
<span class="line"><span style="color:#E1E4E8;">    checksum </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">hash</span><span style="color:#E1E4E8;">.hexdigest()</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&quot;Hash was: </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">checksum</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">@app.route</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;/special-api&#39;</span><span style="color:#24292E;">, </span><span style="color:#E36209;">methods</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">[</span><span style="color:#032F62;">&#39;POST&#39;</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">special_api</span><span style="color:#24292E;">():</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">hash</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> generate_checksum(request)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># Accessing this parses the input stream</span></span>
<span class="line"><span style="color:#24292E;">    files </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> request.files</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># At this point the hash is fully constructed.</span></span>
<span class="line"><span style="color:#24292E;">    checksum </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">hash</span><span style="color:#24292E;">.hexdigest()</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&quot;Hash was: </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">checksum</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&quot;</span></span></code></pre></div>`,8),o=[e];function t(c,r,E,y,i,h){return a(),n("div",null,o)}const F=s(p,[["render",t]]);export{d as __pageData,F as default};
