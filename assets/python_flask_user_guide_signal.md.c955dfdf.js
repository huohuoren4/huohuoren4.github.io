import{_ as s,o as a,c as n,Q as e}from"./chunks/framework.01af844e.js";const g=JSON.parse('{"title":"Signals","description":"","frontmatter":{},"headers":[],"relativePath":"python/flask/user_guide/signal.md","filePath":"python/flask/user_guide/signal.md","lastUpdated":1693328004000}'),l={name:"python/flask/user_guide/signal.md"},p=e(`<h1 id="signals" tabindex="-1">Signals <a class="header-anchor" href="#signals" aria-label="Permalink to &quot;Signals {#signals}&quot;">​</a></h1><p>Signals are a lightweight way to notify subscribers of certain events during the lifecycle of the application and each request. When an event occurs, it emits the signal, which calls each subscriber.</p><p>Signals are implemented by the Blinker library. See its documentation for detailed information. Flask provides some built-in signals. Extensions may provide their own.</p><p>Many signals mirror Flask’s decorator-based callbacks with similar names. For example, the <code>request_started</code> signal is similar to the <code>before_request()</code> decorator. The advantage of signals over handlers is that they can be subscribed to temporarily, and can’t directly affect the application. This is useful for testing, metrics, auditing, and more. For example, if you want to know what templates were rendered at what parts of what requests, there is a signal that will notify you of that information.</p><h2 id="core-signals" tabindex="-1">Core Signals <a class="header-anchor" href="#core-signals" aria-label="Permalink to &quot;Core Signals {#core-signals}&quot;">​</a></h2><p>See <a href="/python/flask/api_reference/signal#signals">Signals</a> for a list of all built-in signals. The <a href="/python/flask/user_guide/app_structure#application-structure-and-lifecycle">Application Structure and Lifecycle</a> page also describes the order that signals and decorators execute.</p><h2 id="subscribing-to-signals" tabindex="-1">Subscribing to Signals <a class="header-anchor" href="#subscribing-to-signals" aria-label="Permalink to &quot;Subscribing to Signals {#subscribing-to-signals}&quot;">​</a></h2><p>To subscribe to a signal, you can use the <code>connect()</code> method of a signal. The first argument is the function that should be called when the signal is emitted, the optional second argument specifies a sender. To unsubscribe from a signal, you can use the <code>disconnect()</code> method.</p><p>For all core Flask signals, the sender is the application that issued the signal. When you subscribe to a signal, be sure to also provide a sender unless you really want to listen for signals from all applications. This is especially true if you are developing an extension.</p><p>For example, here is a helper context manager that can be used in a unit test to determine which templates were rendered and what variables were passed to the template:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flask </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> template_rendered</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> contextlib </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> contextmanager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">@contextmanager</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">captured_templates</span><span style="color:#E1E4E8;">(app):</span></span>
<span class="line"><span style="color:#E1E4E8;">    recorded </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> []</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">record</span><span style="color:#E1E4E8;">(sender, template, context, </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">extra):</span></span>
<span class="line"><span style="color:#E1E4E8;">        recorded.append((template, context))</span></span>
<span class="line"><span style="color:#E1E4E8;">    template_rendered.connect(record, app)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">try</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">yield</span><span style="color:#E1E4E8;"> recorded</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">finally</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">        template_rendered.disconnect(record, app)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flask </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> template_rendered</span></span>
<span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> contextlib </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> contextmanager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">@contextmanager</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">captured_templates</span><span style="color:#24292E;">(app):</span></span>
<span class="line"><span style="color:#24292E;">    recorded </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> []</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">record</span><span style="color:#24292E;">(sender, template, context, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">extra):</span></span>
<span class="line"><span style="color:#24292E;">        recorded.append((template, context))</span></span>
<span class="line"><span style="color:#24292E;">    template_rendered.connect(record, app)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">try</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">yield</span><span style="color:#24292E;"> recorded</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">finally</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">        template_rendered.disconnect(record, app)</span></span></code></pre></div><p>This can now easily be paired with a test client:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> captured_templates(app) </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> templates:</span></span>
<span class="line"><span style="color:#E1E4E8;">    rv </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> app.test_client().get(</span><span style="color:#9ECBFF;">&#39;/&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">assert</span><span style="color:#E1E4E8;"> rv.status_code </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">assert</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(templates) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">    template, context </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> templates[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">assert</span><span style="color:#E1E4E8;"> template.name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;index.html&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">assert</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(context[</span><span style="color:#9ECBFF;">&#39;items&#39;</span><span style="color:#E1E4E8;">]) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">10</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">with</span><span style="color:#24292E;"> captured_templates(app) </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> templates:</span></span>
<span class="line"><span style="color:#24292E;">    rv </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> app.test_client().get(</span><span style="color:#032F62;">&#39;/&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">assert</span><span style="color:#24292E;"> rv.status_code </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">assert</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(templates) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">    template, context </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> templates[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">assert</span><span style="color:#24292E;"> template.name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;index.html&#39;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">assert</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(context[</span><span style="color:#032F62;">&#39;items&#39;</span><span style="color:#24292E;">]) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">10</span></span></code></pre></div><p>Make sure to subscribe with an extra <code>**extra</code> argument so that your calls don’t fail if Flask introduces new arguments to the signals.</p><p>All the template rendering in the code issued by the application app in the body of the <code>with</code> block will now be recorded in the templates variable. Whenever a template is rendered, the template object as well as context are appended to it.</p><p>Additionally there is a convenient helper method (<code>connected_to()</code>) that allows you to temporarily subscribe a function to a signal with a context manager on its own. Because the return value of the context manager cannot be specified that way, you have to pass the list in as an argument:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flask </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> template_rendered</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">captured_templates</span><span style="color:#E1E4E8;">(app, recorded, </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">extra):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">record</span><span style="color:#E1E4E8;">(sender, template, context):</span></span>
<span class="line"><span style="color:#E1E4E8;">        recorded.append((template, context))</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> template_rendered.connected_to(record, app)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flask </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> template_rendered</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">captured_templates</span><span style="color:#24292E;">(app, recorded, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">extra):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">record</span><span style="color:#24292E;">(sender, template, context):</span></span>
<span class="line"><span style="color:#24292E;">        recorded.append((template, context))</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> template_rendered.connected_to(record, app)</span></span></code></pre></div><p>The example above would then look like this:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">templates </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> []</span></span>
<span class="line"><span style="color:#F97583;">with</span><span style="color:#E1E4E8;"> captured_templates(app, templates, </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">extra):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">    template, context </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> templates[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">]</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">templates </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> []</span></span>
<span class="line"><span style="color:#D73A49;">with</span><span style="color:#24292E;"> captured_templates(app, templates, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">extra):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">...</span></span>
<span class="line"><span style="color:#24292E;">    template, context </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> templates[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">]</span></span></code></pre></div><h2 id="creating-signals" tabindex="-1">Creating Signals <a class="header-anchor" href="#creating-signals" aria-label="Permalink to &quot;Creating Signals {#creating-signals}&quot;">​</a></h2><p>If you want to use signals in your own application, you can use the blinker library directly. The most common use case are named signals in a custom <code>Namespace</code>. This is what is recommended most of the time:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> blinker </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> Namespace</span></span>
<span class="line"><span style="color:#E1E4E8;">my_signals </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Namespace()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> blinker </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> Namespace</span></span>
<span class="line"><span style="color:#24292E;">my_signals </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Namespace()</span></span></code></pre></div><p>Now you can create new signals like this:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">model_saved </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> my_signals.signal(</span><span style="color:#9ECBFF;">&#39;model-saved&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">model_saved </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> my_signals.signal(</span><span style="color:#032F62;">&#39;model-saved&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>The name for the signal here makes it unique and also simplifies debugging. You can access the name of the signal with the <code>name</code> attribute.</p><h2 id="sending-signals" tabindex="-1">Sending Signals <a class="header-anchor" href="#sending-signals" aria-label="Permalink to &quot;Sending Signals {#sending-signals}&quot;">​</a></h2><p>If you want to emit a signal, you can do so by calling the <code>send()</code> method. It accepts a sender as first argument and optionally some keyword arguments that are forwarded to the signal subscribers:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Model</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">object</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">save</span><span style="color:#E1E4E8;">(self):</span></span>
<span class="line"><span style="color:#E1E4E8;">        model_saved.send(</span><span style="color:#79B8FF;">self</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Model</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">object</span><span style="color:#24292E;">):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">save</span><span style="color:#24292E;">(self):</span></span>
<span class="line"><span style="color:#24292E;">        model_saved.send(</span><span style="color:#005CC5;">self</span><span style="color:#24292E;">)</span></span></code></pre></div><p>Try to always pick a good sender. If you have a class that is emitting a signal, pass <code>self</code> as sender. If you are emitting a signal from a random function, you can pass <code>current_app._get_current_object()</code> as sender.</p><div class="tip custom-block"><p class="custom-block-title">Passing Proxies as Senders</p><p>Never pass <code>current_app</code> as sender to a signal. Use <code>current_app._get_current_object()</code> instead. The reason for this is that <code>current_app</code> is a proxy and not the real application object.</p></div><h2 id="signals-and-flask-s-request-context" tabindex="-1">Signals and Flask&#39;s Request Context <a class="header-anchor" href="#signals-and-flask-s-request-context" aria-label="Permalink to &quot;Signals and Flask&#39;s Request Context {#signals-and-flask-s-request-context}&quot;">​</a></h2><p>Signals fully support <a href="/python/flask/user_guide/request_context#the-request-context">The Request Context</a> when receiving signals. Context-local variables are consistently available between <code>request_started</code> and <code>request_finished</code>, so you can rely on <code>flask.g</code> and others as needed. Note the limitations described in <a href="/python/flask/user_guide/signal#sending-signals">Sending Signals</a> and the <code>request_tearing_down</code> signal.</p><h2 id="decorator-based-signal-subscriptions" tabindex="-1">Decorator Based Signal Subscriptions <a class="header-anchor" href="#decorator-based-signal-subscriptions" aria-label="Permalink to &quot;Decorator Based Signal Subscriptions {#decorator-based-signal-subscriptions}&quot;">​</a></h2><p>You can also easily subscribe to signals by using the <code>connect_via()</code> decorator:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> flask </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> template_rendered</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">@template_rendered.connect_via</span><span style="color:#E1E4E8;">(app)</span></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">when_template_rendered</span><span style="color:#E1E4E8;">(sender, template, context, </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">extra):</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">print</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">f</span><span style="color:#9ECBFF;">&#39;Template </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">template.name</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;"> is rendered with </span><span style="color:#79B8FF;">{</span><span style="color:#E1E4E8;">context</span><span style="color:#79B8FF;">}</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">from</span><span style="color:#24292E;"> flask </span><span style="color:#D73A49;">import</span><span style="color:#24292E;"> template_rendered</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">@template_rendered.connect_via</span><span style="color:#24292E;">(app)</span></span>
<span class="line"><span style="color:#D73A49;">def</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">when_template_rendered</span><span style="color:#24292E;">(sender, template, context, </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">extra):</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">print</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">f</span><span style="color:#032F62;">&#39;Template </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">template.name</span><span style="color:#005CC5;">}</span><span style="color:#032F62;"> is rendered with </span><span style="color:#005CC5;">{</span><span style="color:#24292E;">context</span><span style="color:#005CC5;">}</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">)</span></span></code></pre></div>`,35),o=[p];function t(c,r,i,y,d,E){return a(),n("div",null,o)}const u=s(l,[["render",t]]);export{g as __pageData,u as default};
